---
layout: post
tag: rsyslog, logrotate, oracle, linux, тупняк
title: Баг пакета rsyslogd в Orale Linux 7
---

Недавно столкнулся с проблемой локальных логов на Oracle Linux 7. Проблема от пользователей (ну как пользователей, скорее администраторов приложений) звучала так: "Перестали писаться логи". Беглая проверка показывает, что на самом деле все последние файлы логов пусты. Rsyslogd запущен. Перезапуск Rsyslogd проблему решает. Через неделю проблема повторяется, при чем на всех серверах. Становится понятно, что логи перестают писаться в момент срабатывания logrotate, а более детальная проверка показывает, чо они и не перестают писаться вовсе. Дело в том, что после переименовывания фаайла с логом (например из messages в messages-20150604) rsyslogd продолжает писать в него.

Значит проблема где-то в районе отправки SIGHUP процессу rsyslog. Вообще говоря, в rsyslog, в отличии от большинства современных демонов, SIGHUP служит не для перезагрузки конфига, а для обновления дескрипторов открытых файлов. Т.е. как раз для того, чтобы после перемещения лога, начать писать в новый файл. Т.е. симптомы указыват на то, что rsyslog либо не получает, либо не обрабатывает SIGHUP. 
 
При этом найти в интернете упоминания о похожей проблме не получается. Это вообще довольно странно. Т.е. проблема явно не глобальная, а "наша". Проверяю конфиг logrotate.

```bash
/var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
{
    sharedscripts
    postrotate
	/bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```
Вроде все верно. На всякий случай проверяю, что в файле /var/run/syslogd.pid. А такого файла нет. Зато есть /var/run/syslogd.pid. Ну как жеж так. Проверяю конфиг, проверяю параметры запуска. Не понятно, почему у нас rsyslog вдруг пишет pid не в тот файл. О том, что проблема локальная, повторюсь, говорит то, что никто в сети с ней не сталкивался. В качестве последней надежды пытаюсь посмотреть как скомпилирован бинарник:

```bash
# strings /sbin/rsyslogd | grep "\.pid"
/var/run/rsyslogd.pid
```
И тут я вспоминаю факт, о котором совсем забыл. Это же Oracle Linux 7, а не CentOS 7. У них закрытый багтрекер и, скорее всего, в нем есть заведеный баг о этой проблеме, но для гугла он недоступен.

Для проверки запускаю ту же команду на сервере с CentOS 7.

```bash
# strings /sbin/rsyslogd | grep "\.pid"
/var/run/syslogd.pid
```
Разумеется, для этой проблемы есть несколько решений. Самое простое, наверное, поправить файл logrotate и дописать туда недостающую (или лишнюю, учитывая производность Oracle linux) букву r.